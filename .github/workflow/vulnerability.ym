name: Create Jira Ticket for Vulnerabilities

on:
  code_scanning_alert:
    types:
      - created

jobs:
  create-jira-ticket:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Create Jira Ticket
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
        run: |
          # Extract vulnerability details from the alert payload
          VULNERABILITY_INFO=$(echo "${{ github.event.client_payload.alerts }}" | jq -r '.[0].message')

          # Create a Jira ticket using the Jira API
          JIRA_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Basic $(echo -n <your_jira_email>:${JIRA_API_TOKEN} | base64)" \
            -H "Content-Type: application/json" \
            -d '{
              "fields": {
                "project": {
                  "key": "YOURPROJECT"
                },
                "summary": "Vulnerability Detected",
                "description": "'"${VULNERABILITY_INFO}"'"
              }
            }' \
            ${JIRA_BASE_URL}/rest/api/2/issue/)

          # Extract the newly created Jira issue key
          JIRA_ISSUE_KEY=$(echo $JIRA_RESPONSE | jq -r '.key')

          echo "Created Jira ticket: ${JIRA_BASE_URL}/browse/${JIRA_ISSUE_KEY}"

